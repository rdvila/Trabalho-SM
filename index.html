<!doctype html>
<html>
	<head>
		<style type="text/css">
			html, body {
				margin: 0px;
			}
			
			canvas {
				border:2px;
				display: block;
				margin-top: 2px;
				margin-left: 2px;
				border-style: solid;
				border-color: #000000;
			}
		</style>
	</head>
	<body>
		<canvas id="myCanvas"></canvas>
		<script>

			var selectedPolygon = null;
			var startDrag       = false;

			var poligono1 = {name: "poligono1", 
							 color: "#AA0000",
			                 connected: false,
							 vertex:  [[0, 0], [10, 0], [10, 10], [0, 10]],
							 offsetX: 500,
							 offsetY: 500
			};

			var poligono2 = {name: "poligono2",
							 color: "#CC00AA",
			                 connected: false,
							 vertex:  [[0, 0], [60, 0], [60, 60]],
							 offsetX: 200,
							 offsetY: 200
			};

			var poligonos = [ poligono1, poligono2 ];

			function setSize(canvas) {
				canvas.width = window.innerWidth - 8,
				canvas.height = window.innerHeight - 8;
			}

			function writeMessage(context, message) {
				context.font = '18pt Calibri';
				context.fillStyle = 'black';
				context.fillText(message, 10, 25);
			}

			function draw(canvas, evt) {
				var context = canvas.getContext('2d');
				context.clearRect(0, 0, canvas.width, canvas.height);

				var currentPoint = getMousePos(canvas, evt);
				var message = 'Mouse position: ' + currentPoint.x + ',' + currentPoint.y;
				writeMessage(context, message);

				poligonos.forEach(function(p) {
					context.beginPath();
					context.fillStyle = p.color;
					for (var i=0; i<p.vertex.length; i+=1) {
						if (i === 0) {
							context.moveTo(p.vertex[i][0]+p.offsetX, p.vertex[i][1]+p.offsetY);
						}
						context.lineTo(p.vertex[i][0]+p.offsetX, p.vertex[i][1]+p.offsetY);
					}
					context.lineTo(p.vertex[0][0]+p.offsetX, p.vertex[0][1]+p.offsetY);
					context.fill();
					context.closePath();
				});		
			}


			function getMousePos(canvas, evt) {
				var rect = canvas.getBoundingClientRect();
				return {
					x: evt.clientX - rect.left,
					y: evt.clientY - rect.top
				};
			}

			function findSelectedPolygon(mousepos) {
				var selectedPolygon = null;
				poligonos.forEach(function(p) {
					var result = inside(mousepos.x, mousepos.y, p.offsetX, p.offsetY, p.vertex);
					if (result) {
						selectedPolygon = p;
					}
				});

				return selectedPolygon;
			}

			function inside(pointX, pointY, offsetX, offsetY, vs) {
				// ray-casting algorithm based on
				// http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html

				var x = pointX, y = pointY;

				var inside = false;
				for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
					var xi = vs[i][0]+offsetX, yi = vs[i][1]+offsetY;
					var xj = vs[j][0]+offsetX, yj = vs[j][1]+offsetY;

					var intersect = ((yi > y) != (yj > y))
						&& (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
					if (intersect) inside = !inside;
				}

				return inside;
			}

			function dragSelectedPolygon(mousePos) {
				if (startDrag === true && selectedPolygon !== null) {
					selectedPolygon.offsetX = mousePos.x;
					selectedPolygon.offsetY = mousePos.y;
				}
			}

			window.onload = function() {
				var canvas = document.getElementById("myCanvas");
				context = canvas.getContext("2d");
				setSize(canvas);

				window.canvas = canvas;
				window.context = context;

				canvas.addEventListener('mousedown', function(evt) {
					var mousePos    = getMousePos(canvas, evt);
					var currentSelectedPolygon = findSelectedPolygon(mousePos);
					if (currentSelectedPolygon !== null) {
						selectedPolygon = currentSelectedPolygon;
						startDrag       = true;
					} else {
						selectedPolygon = null;
						startDrag       = false;
					}
				}, false);

				canvas.addEventListener('mouseup', function(evt) {
					var mousePos    = getMousePos(canvas, evt);
					startDrag       = false;
					selectedPolygon = null;
				}, false);

				canvas.addEventListener('mousemove', function(evt) {
					draw(canvas, evt);
					dragSelectedPolygon(getMousePos(canvas, evt));
				}, false);
			}

			window.onresize = function() {
				setSize(window.canvas);
			};
		</script>
	</body>
</html>